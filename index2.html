<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SHAD0W W0RLD *** VARJ0 VIRTA</title>
    <meta name="description" content="SHAD0W W0RLD" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lacquer&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Kode+Mono:wght@400..700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0;
        padding: 20px;
        background: black;
      }

      .container {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
      }

      .admin {
        grid-column: 1 / -1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-radius: 10px;
        background: #111;
        color: #ccc;
        font-family: "Kode Mono", system-ui, monospace;
        font-size: 13px;
        text-transform: uppercase;
      }

      .admin-status {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .admin-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #22c55e;
        flex-shrink: 0;
      }

      .admin-dot.unsaved {
        background: #ef4444;
      }

      .admin-sync-btn {
        font-family: "Kode Mono", system-ui, monospace;
        font-size: 13px;
        text-transform: uppercase;
        padding: 8px 16px;
        border-radius: 6px;
        border: 1px solid #333;
        background: #222;
        color: #eee;
        cursor: pointer;
      }

      .admin-sync-btn:hover {
        background: #333;
      }

      .block {
        padding: 20px;
        border-radius: 10px;
        background: blue;
        color: white;
        display: grid;
        gap: 10px;
      }

      .block-category,
      .block-title-input,
      .block-body {
        font-family: "Kode Mono", system-ui, monospace;
        font-weight: 400;
        font-style: normal;
        font-size: 15px;
        background: transparent;
        color: inherit;
        border: none;
        outline: none;
        padding: 0;
        margin: 0;
        width: 100%;
        resize: none;
      }

      .block-category {
        text-transform: uppercase;
      }

      .block-title-input {
        font-family: "Lacquer", system-ui;
        font-size: 50px;
        line-height: 1;
      }

      .block-title-input::placeholder,
      .block-category::placeholder,
      .block-body::placeholder {
        opacity: 0.6;
      }

      .block-body {
        min-height: 80px;
        line-height: 1.4;
      }

      .block-body:focus,
      .block-title-input:focus,
      .block-category:focus {
        outline: none;
        box-shadow: none;
      }

      .add-block-wrap {
        grid-column: 1 / -1;
        display: flex;
        justify-content: center;
        padding: 20px 0 10px;
      }

      .add-block-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 2px solid #333;
        background: #111;
        color: #888;
        font-size: 24px;
        line-height: 1;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition:
          background 0.15s,
          color 0.15s;
      }

      .add-block-btn:hover {
        background: #222;
        color: #fff;
      }

      #blocksRoot {
        grid-column: 1 / -1;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
      }

      /* Token modal */
      .token-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
      }

      .token-modal[hidden] {
        display: none;
      }

      .token-modal-inner {
        background: #111;
        padding: 24px;
        border-radius: 10px;
        max-width: 360px;
        width: calc(100% - 40px);
        border: 1px solid #333;
      }

      .token-modal-inner h2 {
        font-family: "Kode Mono", system-ui, monospace;
        font-size: 14px;
        text-transform: uppercase;
        color: #ccc;
        margin: 0 0 8px;
      }

      .token-modal-inner p {
        font-family: "Kode Mono", system-ui, monospace;
        font-size: 13px;
        color: #888;
        margin: 0 0 16px;
      }

      .token-modal-inner input {
        width: 100%;
        box-sizing: border-box;
        padding: 10px 12px;
        font-family: "Kode Mono", system-ui, monospace;
        font-size: 13px;
        background: #222;
        border: 1px solid #333;
        border-radius: 6px;
        color: #eee;
        margin-bottom: 16px;
      }

      .token-modal-inner input:focus {
        outline: none;
        border-color: #555;
      }

      .token-modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .token-modal-actions button {
        font-family: "Kode Mono", system-ui, monospace;
        font-size: 13px;
        text-transform: uppercase;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
      }

      .token-save {
        background: blue;
        color: white;
        border: none;
      }

      .token-save:hover {
        filter: brightness(1.1);
      }

      .token-skip {
        background: transparent;
        color: #888;
        border: 1px solid #333;
      }

      .token-skip:hover {
        background: #222;
        color: #ccc;
      }
    </style>
  </head>
  <body>
    <!-- Token modal: shown on start if no token -->
    <div class="token-modal" id="tokenModal" hidden>
      <div class="token-modal-inner">
        <h2>GitHub Gist sync</h2>
        <p>
          Paste a GitHub personal access token with Gist scope. It is stored
          only on this device. You can skip and set it later.
        </p>
        <input
          type="password"
          id="githubTokenInput"
          placeholder="GitHub token (gist scope)"
          autocomplete="off"
          spellcheck="false"
        />
        <div class="token-modal-actions">
          <button type="button" class="token-skip" id="tokenSkipBtn">
            Skip
          </button>
          <button type="button" class="token-save" id="tokenSaveBtn">
            Save token
          </button>
        </div>
      </div>
    </div>

    <div class="container" id="container">
      <div class="admin" id="adminBar">
        <div class="admin-status">
          <span class="admin-dot" id="adminDot"></span>
          <span id="adminLabel">SYNCED</span>
        </div>
        <button type="button" class="admin-sync-btn" id="syncBtn">Sync</button>
      </div>

      <div id="blocksRoot"></div>

      <div class="add-block-wrap">
        <button
          type="button"
          class="add-block-btn"
          id="addBlockBtn"
          title="Add block"
        >
          +
        </button>
      </div>
    </div>

    <script>
      (function () {
        const GITHUB_TOKEN_KEY = "lightworldGithubToken";
        const GIST_ID_KEY = "lightworldGistId";
        const DATA_KEY = "lightworldData";
        const LAST_SYNCED_KEY = "lightworldLastSynced";
        const FILE_NAME = "lightworld.json";

        let blocks = [];
        let gistId = null;
        let isDirty = false;

        function getToken() {
          try {
            return localStorage.getItem(GITHUB_TOKEN_KEY) || "";
          } catch (_) {
            return "";
          }
        }

        function setToken(token) {
          try {
            if (token && token.trim()) {
              localStorage.setItem(GITHUB_TOKEN_KEY, token.trim());
            } else {
              localStorage.removeItem(GITHUB_TOKEN_KEY);
            }
          } catch (_) {}
        }

        function getStoredGistId() {
          try {
            return localStorage.getItem(GIST_ID_KEY) || null;
          } catch (_) {
            return null;
          }
        }

        function setStoredGistId(id) {
          try {
            if (id) localStorage.setItem(GIST_ID_KEY, id);
            else localStorage.removeItem(GIST_ID_KEY);
          } catch (_) {}
        }

        function getLastSynced() {
          try {
            return localStorage.getItem(LAST_SYNCED_KEY);
          } catch (_) {
            return null;
          }
        }

        function setLastSynced(json) {
          try {
            if (json != null) localStorage.setItem(LAST_SYNCED_KEY, json);
            else localStorage.removeItem(LAST_SYNCED_KEY);
          } catch (_) {}
        }

        function readLocalBlocks() {
          try {
            const raw = localStorage.getItem(DATA_KEY);
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : null;
          } catch (_) {
            return null;
          }
        }

        function writeLocalBlocks() {
          try {
            localStorage.setItem(DATA_KEY, JSON.stringify(blocks));
          } catch (_) {}
        }

        function setDirty(dirty) {
          isDirty = !!dirty;
          const dot = document.getElementById("adminDot");
          const label = document.getElementById("adminLabel");
          if (dot) dot.classList.toggle("unsaved", isDirty);
          if (label) label.textContent = isDirty ? "UNSAVED CHANGES" : "SYNCED";
        }

        function saveFromUI() {
          writeLocalBlocks();
          const json = JSON.stringify(blocks, null, 2);
          if (getLastSynced() === json) {
            setDirty(false);
          } else {
            setDirty(true);
          }
        }

        function blockToData(blockEl) {
          const id = blockEl.dataset.blockId;
          const category =
            (blockEl.querySelector(".block-category") || {}).value || "";
          const title =
            (blockEl.querySelector(".block-title-input") || {}).value || "";
          const body = (blockEl.querySelector(".block-body") || {}).value || "";
          return { id, category, title, body };
        }

        function dataToBlock(data) {
          const div = document.createElement("div");
          div.className = "block";
          div.dataset.blockId = data.id;
          div.innerHTML = `
            <input type="text" class="block-category" placeholder="Category" value="${escapeAttr(data.category)}" />
            <input type="text" class="block-title-input" placeholder="Title" value="${escapeAttr(data.title)}" />
            <textarea class="block-body" placeholder="Content goes here" rows="4">${escapeHtml(data.body)}</textarea>
          `;
          const category = div.querySelector(".block-category");
          const title = div.querySelector(".block-title-input");
          const body = div.querySelector(".block-body");
          function onInput() {
            blocks = blocks.map((b) =>
              b.id === data.id ? { ...b, ...blockToData(div) } : b,
            );
            saveFromUI();
          }
          category.addEventListener("input", onInput);
          title.addEventListener("input", onInput);
          body.addEventListener("input", onInput);
          return div;
        }

        function escapeAttr(s) {
          if (s == null) return "";
          return String(s)
            .replace(/&/g, "&amp;")
            .replace(/"/g, "&quot;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }

        function escapeHtml(s) {
          if (s == null) return "";
          return String(s)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
        }

        function addBlock(data) {
          const id =
            data.id ||
            "b-" + Date.now() + "-" + Math.random().toString(36).slice(2, 9);
          const block = {
            id,
            category: data.category != null ? data.category : "",
            title: data.title != null ? data.title : "",
            body: data.body != null ? data.body : "",
          };
          blocks.push(block);
          const root = document.getElementById("blocksRoot");
          const el = dataToBlock(block);
          root.appendChild(el);
          saveFromUI();
        }

        function renderBlocks() {
          const root = document.getElementById("blocksRoot");
          root.innerHTML = "";
          blocks.forEach((b) => root.appendChild(dataToBlock(b)));
          setDirty(isDirty);
        }

        async function loadData() {
          const token = getToken();
          if (!token) {
            const local = readLocalBlocks();
            if (local && local.length) {
              blocks = local;
              setDirty(true);
            } else {
              blocks = [{ id: "b-1", category: "", title: "", body: "" }];
              writeLocalBlocks();
              setDirty(true);
            }
            renderBlocks();
            return;
          }

          const savedId = getStoredGistId();
          if (savedId) {
            try {
              const res = await fetch(
                `https://api.github.com/gists/${savedId}`,
                {
                  headers: {
                    Authorization: `Bearer ${token}`,
                    Accept: "application/vnd.github.v3+json",
                  },
                },
              );
              if (res.ok) {
                const gist = await res.json();
                const file = Object.values(gist.files || {})[0];
                if (file && file.content) {
                  const parsed = JSON.parse(file.content);
                  if (Array.isArray(parsed)) {
                    gistId = savedId;
                    blocks = parsed;
                    writeLocalBlocks();
                    setLastSynced(JSON.stringify(blocks, null, 2));
                    setDirty(false);
                    renderBlocks();
                    return;
                  }
                }
              } else {
                setStoredGistId(null);
              }
            } catch (_) {
              setStoredGistId(null);
            }
          }

          const listRes = await fetch("https://api.github.com/gists", {
            headers: {
              Authorization: `Bearer ${token}`,
              Accept: "application/vnd.github.v3+json",
            },
          });
          if (listRes.ok) {
            const gists = await listRes.json();
            const found = gists.find((g) => {
              const files = Object.values(g.files || {});
              return files.some(
                (f) =>
                  (f.filename || "").includes("lightworld") ||
                  (f.filename || "").endsWith(".json"),
              );
            });
            if (found) {
              const fullRes = await fetch(
                `https://api.github.com/gists/${found.id}`,
                {
                  headers: {
                    Authorization: `Bearer ${token}`,
                    Accept: "application/vnd.github.v3+json",
                  },
                },
              );
              if (fullRes.ok) {
                const full = await fullRes.json();
                const file = Object.values(full.files || {})[0];
                if (file && file.content) {
                  const parsed = JSON.parse(file.content);
                  if (Array.isArray(parsed)) {
                    gistId = found.id;
                    setStoredGistId(gistId);
                    blocks = parsed;
                    writeLocalBlocks();
                    setLastSynced(JSON.stringify(blocks, null, 2));
                    setDirty(false);
                    renderBlocks();
                    return;
                  }
                }
              }
            }
          }

          const local = readLocalBlocks();
          if (local && local.length) {
            blocks = local;
          } else {
            blocks = [{ id: "b-1", category: "", title: "", body: "" }];
          }
          writeLocalBlocks();
          setDirty(true);
          renderBlocks();
        }

        async function syncToGist() {
          const token = getToken();
          if (!token) {
            openTokenModal();
            return;
          }

          const json = JSON.stringify(blocks, null, 2);

          if (!gistId) {
            const res = await fetch("https://api.github.com/gists", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                Accept: "application/vnd.github.v3+json",
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                description: "Lightworld data",
                public: false,
                files: { [FILE_NAME]: { content: json } },
              }),
            });
            if (!res.ok) {
              const err = await res.text();
              alert("Sync failed: " + (err || res.status));
              return;
            }
            const gist = await res.json();
            gistId = gist.id;
            setStoredGistId(gistId);
          } else {
            const res = await fetch(`https://api.github.com/gists/${gistId}`, {
              method: "PATCH",
              headers: {
                Authorization: `Bearer ${token}`,
                Accept: "application/vnd.github.v3+json",
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                files: { [FILE_NAME]: { content: json } },
              }),
            });
            if (!res.ok) {
              const err = await res.text();
              alert("Sync failed: " + (err || res.status));
              return;
            }
          }

          writeLocalBlocks();
          setLastSynced(json);
          setDirty(false);
        }

        function openTokenModal() {
          const modal = document.getElementById("tokenModal");
          const input = document.getElementById("githubTokenInput");
          if (modal) modal.hidden = false;
          if (input) {
            input.value = getToken() ? "***" : "";
            input.placeholder = getToken()
              ? "Token set â€“ paste to replace"
              : "GitHub token (gist scope)";
            input.focus();
          }
        }

        function closeTokenModal() {
          const modal = document.getElementById("tokenModal");
          if (modal) modal.hidden = true;
        }

        document
          .getElementById("tokenSaveBtn")
          .addEventListener("click", () => {
            const input = document.getElementById("githubTokenInput");
            const raw = (input && input.value.trim()) || "";
            if (raw && raw !== "***") setToken(raw);
            closeTokenModal();
          });

        document
          .getElementById("tokenSkipBtn")
          .addEventListener("click", () => {
            closeTokenModal();
          });

        document.getElementById("syncBtn").addEventListener("click", () => {
          syncToGist();
        });

        document.getElementById("addBlockBtn").addEventListener("click", () => {
          addBlock({ category: "", title: "", body: "" });
        });

        document.addEventListener("DOMContentLoaded", () => {
          if (!getToken()) {
            openTokenModal();
          }
          loadData();
        });
      })();
    </script>
  </body>
</html>
